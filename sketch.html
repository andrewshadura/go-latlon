<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
        <title>LatLon.org</title>
        <meta name="generator" content="Amaya, see http://www.w3.org/Amaya/" />
        
        <link rel="stylesheet" href="../theme/default/style.css" type="text/css" />
        <link rel="stylesheet" href="style.css" type="text/css" />
        <!-- script src="/js/prototype.js" type="text/javascript"></script -->
        <script src="http://www.openlayers.org/api/OpenLayers.js" type="text/javascript"></script>
        <script src="lib.js" type="text/javascript"></script>

        <script type="text/javascript">
  // <![CDATA[
  var lon = 5;
  var lat = 40;
  var zoom = 5;
  var map, wkt;
  var mapnik, yasat, yhsat, gshtab, road, bel, vector, pt, irs; /* layer holders */
  var uo; /* user logged in */
        
  OpenLayers.IMAGE_RELOAD_ATTEMPTS = 3;
  OpenLayers.Util.onImageLoadErrorColor = "transparent";

  function init(){
    updateSignIn();

    OpenLayers.Control.Permalink.prototype.updateLink = function() {
        var href = this.base;
        if (href.indexOf('?') != -1) {
          href = href.substring( 0, href.indexOf('?') );
        }
 
        href += '?' + OpenLayers.Util.getParameterString(this.createParams()) + this.hash;
        this.element.href = href;
    }

    /**
     * Method: update
     * Update the size of the bars, and the labels they contain.
     */
    OpenLayers.Control.ScaleLine.prototype.update = function() {
        var res = this.map.getResolution();
        if (!res) {
            return;
        }

        var curMapUnits = this.map.getUnits();
        var inches = OpenLayers.INCHES_PER_UNIT;
        // scale maxSizeData by cos(lat) if possible

        var center = this.map.getCenter();
        if (center && this.displayProjection && this.displayProjection.projCode == "EPSG:4326") {
          var lat = center.lat;
          var lon = center.lon;

          var mapPosition = OpenLayers.Projection.transform(
            { x: lon, y: lat },
            this.map.getProjectionObject(),
            this.displayProjection
          );

          lon = mapPosition.x;
          lat = mapPosition.y;

          coslat = Math.cos(lat * Math.PI / 180.0);

          // clamp coslat to stop the resolution getting too small near the poles
          if (coslat < 0.01) {
            coslat = 0.01;
          }

          res *= coslat;
        }

        // convert maxWidth to map units
        var maxSizeData = this.maxWidth * res * inches[curMapUnits];

        // decide whether to use large or small scale units
        var topUnits;
        var bottomUnits;
        if(maxSizeData > 100000) {
            topUnits = this.topOutUnits;
            bottomUnits = this.bottomOutUnits;
        } else {
            topUnits = this.topInUnits;
            bottomUnits = this.bottomInUnits;
        }

        // and to map units units
        var topMax = maxSizeData / inches[topUnits];
        var bottomMax = maxSizeData / inches[bottomUnits];

        // now trim this down to useful block length
        var topRounded = this.getBarLen(topMax);
        var bottomRounded = this.getBarLen(bottomMax);

        // and back to display units
        topMax = topRounded / inches[curMapUnits] * inches[topUnits];
        bottomMax = bottomRounded / inches[curMapUnits] * inches[bottomUnits];

        // and to pixel units
        var topPx = topMax / res;
        var bottomPx = bottomMax / res;

        // now set the pixel widths
        // and the values inside them

        if (this.eBottom.style.visibility == "visible"){
            this.eBottom.style.width = Math.round(bottomPx) + "px";
            this.eBottom.innerHTML = bottomRounded + " " + bottomUnits ;
        }

        if (this.eTop.style.visibility == "visible"){
            this.eTop.style.width = Math.round(topPx) + "px";
            this.eTop.innerHTML = topRounded + " " + topUnits;
        }

    };

    var options = {
        projection: new OpenLayers.Projection("EPSG:900913"),
        displayProjection: new OpenLayers.Projection("EPSG:4326"),
        units: "m",
        numZoomLevels: 18,
        maxResolution: 156543.0339,
        maxExtent: new OpenLayers.Bounds(-20037508, -20037508,
                                         20037508, 20037508.34),
        controls: [
          new OpenLayers.Control.MouseDefaults(), 
          new OpenLayers.Control.PanZoomBar(), 
          new OpenLayers.Control.ScaleLine(), 
          new OpenLayers.Control.MousePosition(), 
          new OpenLayers.Control.Permalink(null, null, {"hash": document.location.hash}),
          new OpenLayers.Control.Permalink('edit', 'http://openstreetmap.org/edit', {"hash": ""}),
          new OpenLayers.Control.Permalink('mini', 'http://go.latlon.org/', {"hash": "#mini"}),
          new OpenLayers.Control.Permalink('maxi', 'http://go.latlon.org/', {"hash": "#maxi"}),
          new OpenLayers.Control.Permalink('transport', 'http://go.latlon.org/', {"hash": "#transport"}),
          new OpenLayers.Control.Permalink('sketch', 'http://go.latlon.org/', {"hash": "#sketch"}),
        ]

    };

    map = new OpenLayers.Map('map', options);

    switch (document.location.hash) {
        case "#transport":
        case "#mini": {
            mini();
            miniadd();
        } break;
        case "#maxi": {
            maxi();
            maxiadd();
        } break;
        case "#sketch": {
            sketch();
            sketchadd();
        } break;
    }

    var ls = new OpenLayers.Control.LayerSwitcher();
    map.addControl(ls);
    ls.maximizeControl();

    if (document.location.hash == "#sketch") {
        wkt = new OpenLayers.Format.WKT(
            {
              'internalProjection': new OpenLayers.Projection("EPSG:900913"),
              'externalProjection': new OpenLayers.Projection("EPSG:4326")
            }
        );

        var sketchSymbolizers = {
            "Point": {
              pointRadius: 4,
              graphicName: "square",
              fillColor: "white",
              fillOpacity: 1,
              strokeWidth: 1,
              strokeOpacity: 1,
              strokeColor: "#333333"
            },
            "Line": {
              strokeWidth: 3,
              strokeOpacity: 1,
              strokeColor: "#666666",
              strokeDashstyle: "dash"
            },
            "Polygon": {
              strokeWidth: 2,
              strokeOpacity: 1,
              strokeColor: "#666666",
              fillColor: "white",
              fillOpacity: 0.3
            }
        };

        var mystyle = new OpenLayers.Style();
        mystyle.addRules([
            new OpenLayers.Rule({symbolizer: sketchSymbolizers})
        ]);

        var styleMap=new OpenLayers.StyleMap({"default": mystyle});
        var MLinearCtrlOptions =
        {
            title: 'линейка',
            displayUnits: 'm',
            eventListeners:
            {
              'measure': handleMeasure,
              'measurepartial': handleMeasure,
              'deactivate': hideDistance
            },
            handlerOptions:
            {
              persist: true,
              layerOptions: {styleMap: styleMap}
            }
        };
        edittb = new OpenLayers.Control.EditingToolbar(vector);

        MeasureLinearCtrl = new OpenLayers.Control.Measure(OpenLayers.Handler.Path, MLinearCtrlOptions);
        MeasureLinearCtrl.geodesic = true;
        edittb.addControls([MeasureLinearCtrl]);
        edittb.controls.each(
            function (el) {
              el.events.register("activate", el, function (e) {
                  alert(this);
              });
              el.events.register("deactivate", el, function (e) {
                  alert(this);
              });
            }
        );

        map.addControl(edittb);
    }

    if (!map.getCenter()) {
        var lonlat = new OpenLayers.LonLat(27.62011,53.85267);
        lonlat.transform(map.displayProjection,map.projection);
        map.setCenter(lonlat, 7);
        map.panTo(lonlat);
    }

    handleResize();

    window.onload = handleResize;
    window.onresize = handleResize;
  }

  // ]]>
        </script>
    </head>
    <body onload="init()">
        <p id="top">
          <span id="logo"></span>
          <span class="tabs">
            <a class="action transparent" id="loginlink" onclick="return loginshow();" href="#">sign in</a>
            <a class="tab" id="edit" href="#edit">edit</a>
            <a class="tab" id="maxi" href="#maxi">maxi</a>
            <a class="tab" id="mini" href="#mini">mini</a>
            <a class="tab" id="sketch" href="#sketch">sketch</a>
            <a class="tab" id="transport" href="#transport">transport</a>
          </span>
        </p>
        <form id="loginform" class="form hidden">
            <span class="hidden" id="posturl" title="/user/login">&nbsp;</span>
            <input class="field" id="user" name="user" type="text" value=""/>
            <input class="field" id="password" name="password" type="password" value=""/>
            <span id="logonprogress" class="spin hidden">Logging in...</span>
            <input onclick="return login(); return false;" id="submit" name="submit" type="submit" value="Log in"/>
        </form>
        <div id="content">
            <div id="sidebar"></div>
            <div id="map" class="smallmap" style="border: 1px solid;"></div>
        </div>

        <div id="distance"></div>
    </body>
</html>
